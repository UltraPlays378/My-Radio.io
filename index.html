<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Release Powered React Radio</title>

<script src="libs/react.development.js"></script>
<script src="libs/react-dom.development.js"></script>
<script src="libs/babel.min.js"></script>
<script src="libs/GlitchJS.js"></script>

<style>
body { background: black; color: white; font-family: Arial; padding: 20px; }
button {
  margin: 5px;
  padding: 6px 12px;
  background: #0ff;
  color: black;
  border: none;
  font-weight: bold;
  border-radius: 4px;
  cursor: pointer;
}
button:hover { background: #0cc; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

function OnlineStatus() {
  const [isOnline, setIsOnline] = React.useState(Boolean(GlitchJS.isOnline));

  React.useEffect(() => {
    const interval = setInterval(() => {
      setIsOnline(Boolean(GlitchJS.isOnline));
    }, 500);
    return () => clearInterval(interval);
  }, []);

  return <div>Status: {isOnline ? "Online" : "Offline"}</div>;
}

function AudioPlayer() {
  const audioRef = React.useRef(null);

  const [audioSources, setAudioSources] = React.useState([]);
  const [currentSrc, setCurrentSrc] = React.useState(null);
  const [loading, setLoading] = React.useState(true);

  const lastTrack = React.useRef(null);
  const recentTracks = React.useRef([]);

  // ðŸ”¥ Fetch ALL songs from Releases
  React.useEffect(() => {
    async function fetchReleases() {
      try {
        const res = await fetch(
          "https://api.github.com/repos/UltraPlays378/My-Radio.io/releases"
        );

        const releases = await res.json();
        const songs = [];

        releases.forEach(release => {
          release.assets.forEach(asset => {
            const name = asset.name.toLowerCase();
            if (
              name.endsWith(".mp3") ||
              name.endsWith(".wav") ||
              name.endsWith(".flac")
            ) {
              songs.push(asset.browser_download_url);
            }
          });
        });

        setAudioSources(songs);
        setLoading(false);
      } catch (err) {
        console.error("Failed to fetch releases:", err);
        setLoading(false);
      }
    }

    fetchReleases();
  }, []);

  const getSmartRandomTrack = () => {
    if (!audioSources.length) return null;

    let pool = audioSources.filter(src => src !== lastTrack.current);

    if (recentTracks.current.length >= audioSources.length - 1) {
      recentTracks.current = [];
    }

    pool = pool.filter(src => !recentTracks.current.includes(src));

    const choice = pool[Math.floor(Math.random() * pool.length)];

    recentTracks.current.push(choice);
    lastTrack.current = choice;

    return choice;
  };

  const playRandom = () => {
    const next = getSmartRandomTrack();
    if (next) setCurrentSrc(next);
  };

  React.useEffect(() => {
    if (!currentSrc) return;
    const audio = audioRef.current;
    audio.src = currentSrc;
    audio.play();
  }, [currentSrc]);

  return (
    <div>
      <h1>Release Powered Radio</h1>

      {loading && <p>Loading songs from releases...</p>}

      {!loading && audioSources.length === 0 && (
        <p>No audio files found in releases.</p>
      )}

      <p>Total Tracks: {audioSources.length}</p>

      <p>
        Now Playing:{" "}
        {currentSrc ? currentSrc.split("/").pop() : "None"}
      </p>

      <button onClick={playRandom}>Start / Next</button>

      <br /><br />

      <audio
        ref={audioRef}
        onEnded={playRandom}
        controls
      />
    </div>
  );
}

function App() {
  return (
    <div>
      <OnlineStatus />
      <AudioPlayer />
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>
